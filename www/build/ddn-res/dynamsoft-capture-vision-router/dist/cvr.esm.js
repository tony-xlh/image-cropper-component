/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Capture Vision Router JS Edition
 * @website http://www.dynamsoft.com
 * @copyright Copyright 2023, Dynamsoft Corporation
 * @author Dynamsoft
 * @version "2.0.20-dev-20231215173430"
 * @fileoverview Dynamsoft JavaScript Library for Capture Vision
 * More info on cvr JS: https://www.dynamsoft.com/capture-vision-router/sdk-javascript/
 */
import{engineResourcePaths as e,workerAutoResources as t,mapPackageRegister as i,innerVersions as s,EnumImagePixelFormat as a,EnumCapturedResultItemType as r,CoreModule as n,loadWasm as o,getNextTaskID as c,mapTaskCallBack as l,worker as d,EnumColourChannelUsageType as u,handleParsedResultItem as m}from"@dynamsoft/dynamsoft-core";const h=e=>e&&"object"==typeof e&&"function"==typeof e.then;class g extends Promise{constructor(e){let t,i;super(((e,s)=>{t=e,i=s})),this._s="pending",this.resolve=e=>{this.isPending&&(h(e)?this.task=e:(this._s="fulfilled",t(e)))},this.reject=e=>{this.isPending&&(this._s="rejected",i(e))},this.task=e}get status(){return this._s}get isPending(){return"pending"===this._s}get isFulfilled(){return"fulfilled"===this._s}get isRejected(){return"rejected"===this._s}get task(){return this._task}set task(e){let t;this._task=e,h(e)?t=e:"function"==typeof e&&(t=new Promise(e)),t&&(async()=>{try{const i=await t;e===this._task&&this.resolve(i)}catch(t){e===this._task&&this.reject(t)}})()}get isEmpty(){return null==this._task}}class p{constructor(){this.intermediateResultReceiverSet=new Set}addResultReceiver(e){if("object"!=typeof e)throw new Error("Invalid receiver.");this.intermediateResultReceiverSet.add(e)}removeResultReceiver(e){this.intermediateResultReceiverSet.delete(e)}}var _={onTaskResultsReceived:!1,onTaskResultsReceivedForDce:!1,onPredetectedRegionsReceived:!1,onLocalizedBarcodesReceived:!1,onDecodedBarcodesReceived:!1,onLocalizedTextLinesReceived:!1,onRecognizedTextLinesReceived:!1,onDetectedQuadsReceived:!1,onNormalizedImagesReceived:!1,onColourImageUnitReceived:!1,onScaledDownColourImageUnitReceived:!1,onGrayscaleImageUnitReceived:!1,onTransformedGrayscaleImageUnitReceived:!1,onEnhancedGrayscaleImageUnitReceived:!1,onBinaryImageUnitReceived:!1,onTextureDetectionResultUnitReceived:!1,onTextureRemovedGrayscaleImageUnitReceived:!1,onTextureRemovedBinaryImageUnitReceived:!1,onContoursUnitReceived:!1,onLineSegmentsUnitReceived:!1,onTextZonesUnitReceived:!1,onTextRemovedBinaryImageUnitReceived:!1,onLongLinesUnitReceived:!1,onCornersUnitReceived:!1,onCandidateQuadEdgesUnitReceived:!1,onCandidateBarcodeZonesUnitReceived:!1,onScaledUpBarcodeImageUnitReceived:!1,onDeformationResistedBarcodeImageUnitReceived:!1,onComplementedBarcodeImageUnitReceived:!1};const R="undefined"==typeof self,f=(()=>{if(!R&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})();var I,v;e.cvr=f,t.cvr={js:!0,wasm:!0},i.cvr={};class y{static getVersion(){return this._version}}function S(e,t){if(!e)return[];"string"==typeof e&&(e=JSON.parse(e));let i=[],s=[];function a(t){let i=e.TargetROIDefOptions.filter((e=>t.includes(e.Name)));return i.forEach((e=>{s=s.concat(e.TaskSettingNameArray)})),i}function r(t,a){if(e[t])for(let r=0;r<e[t].length;r++)if(s.includes(e[t][r].Name)){i.push(a);break}}let n=e.CaptureVisionTemplates.findIndex((e=>e.Name===t));n=n<0?0:n;let o=e.CaptureVisionTemplates[n].ImageROIProcessingNameArray||[],c=e.CaptureVisionTemplates[n].SemanticProcessingNameArray,l=a(o).map((e=>{if(e.Location&&e.Location.ReferenceObjectFilter&&e.Location.ReferenceObjectFilter.ReferenceTargetROIDefNameArray)return e.Location.ReferenceObjectFilter.ReferenceTargetROIDefNameArray})).filter(Boolean),d=[];return l.forEach((e=>{d=d.concat(e)})),d=[...new Set(d)],a(d),s=[...new Set(s)],c&&c.length&&i.push("dcp"),r("BarcodeReaderTaskSettingOptions","dbr"),r("LabelRecognizerTaskSettingOptions","dlr"),r("DocumentNormalizerTaskSettingOptions","ddn"),i}async function w(e,t){return await new Promise(((i,s)=>{let a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType=t,a.send(),a.onloadend=async()=>{i(a.response)},a.onerror=()=>{s(new Error("Network Error: "+a.statusText))}}))}y._version=`2.0.20-dev-20231215173430(Worker: ${null===(I=s.cvr)||void 0===I?void 0:I.worker}, Wasm: loading...`,function(e){e[e.ISS_BUFFER_EMPTY=0]="ISS_BUFFER_EMPTY",e[e.ISS_EXHAUSTED=1]="ISS_EXHAUSTED"}(v||(v={}));const b=r;function T(e){const t={barcodesResultItems:[],textLinesResultItems:[],quadsResultItems:[],normalizedImageResultItems:[],parsedResultItems:[]};return e.items.forEach((e=>{e.type===b.CRIT_BARCODE?t.barcodesResultItems.push(e):e.type===b.CRIT_TEXT_LINE?t.textLinesResultItems.push(e):e.type===b.CRIT_DETECTED_QUAD?t.quadsResultItems.push(e):e.type===b.CRIT_NORMALIZED_IMAGE?t.normalizedImageResultItems.push(e):e.type===b.CRIT_PARSED_RESULT&&t.parsedResultItems.push(e)})),t}function D(e){let t,i=e.bytes;if(!(i&&i instanceof Uint8Array))throw Error("Parameter type error");if(Number(e.format)===a.IPF_BGR_888){const e=i.length/3;t=new Uint8ClampedArray(4*e);for(let s=0;s<e;++s)t[4*s]=i[3*s],t[4*s+1]=i[3*s+1],t[4*s+2]=i[3*s+2],t[4*s+3]=255}else if(Number(e.format)===a.IPF_RGB_888){const e=i.length/3;t=new Uint8ClampedArray(4*e);for(let s=0;s<e;++s)t[4*s]=i[3*s+2],t[4*s+1]=i[3*s+1],t[4*s+2]=i[3*s],t[4*s+3]=255}else if(Number(e.format)===a.IPF_GRAYSCALED){const e=i.length;t=new Uint8ClampedArray(4*e);for(let s=0;s<e;s++)t[4*s]=t[4*s+1]=t[4*s+2]=i[s],t[4*s+3]=255}else if(Number(e.format)===a.IPF_BINARY_8){const s=i.length,a=e.width,r=e.height,n=e.stride;t=new Uint8ClampedArray(a*r*4);for(let e=0;e<s;e++){let s=i[e],r=e%n,o=Math.floor(e/n);for(let e=0;e<8;e++){let i=r+e,n=4*(o*a+i);if(i>=a)break;t[n]=t[n+1]=t[n+2]=(128&s)/128*255,t[n+3]=255,s<<=1}}}else if(Number(e.format)===a.IPF_ABGR_8888){const e=i.length/4;t=new Uint8ClampedArray(i.length);for(let s=0;s<e;++s)t[4*s]=i[4*s],t[4*s+1]=i[4*s+1],t[4*s+2]=i[4*s+2],t[4*s+3]=i[4*s+3]}else if(Number(e.format)===a.IPF_ARGB_8888){const e=i.length/4;t=new Uint8ClampedArray(i.length);for(let s=0;s<e;++s)t[4*s]=i[4*s],t[4*s+1]=i[4*s+1],t[4*s+2]=i[4*s+2],t[4*s+3]=i[4*s+3]}return new ImageData(t,e.width,e.height)}function C(e,t){e.toCanvas=()=>L(t),e.toImage=e=>function(e,t){const i=L(t);let s=new Image,a=i.toDataURL(e);return s.src=a,s}(e,t),e.toBlob=e=>k(e,t),e.saveToFile=async(e,i)=>{if(!e)return null;if("string"!=typeof e)throw new TypeError("FileName must be of type string.");return async function(e,t,i){return await new Promise((async(s,a)=>{try{const a=t.split(".");let r=a[a.length-1];const n=await k(`image/${r}`,e);a.length<=1&&(r="png");const o=new File([n],t,{type:`image/${r}`});if(i){const e=URL.createObjectURL(o),i=document.createElement("a");i.href=e,i.download=t,i.click()}return s(o)}catch(e){return a()}}))}(t,e,i)}}function L(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;return t.getContext("2d",{willReadFrequently:!0}).putImageData(e,0,0),t}async function k(e,t){const i=L(t);return new Promise(((t,s)=>{i.toBlob((e=>t(e)),e)}))}const E="function"==typeof BigInt;class O{constructor(){this._maxCvsSideLength=["iPhone","Android","HarmonyOS"].includes(n.browserInfo.OS)?2048:4096,this._isa=null,this._dsImage=null,this._instanceID=void 0,this._bPauseScan=!0,this._bNeedOutputOriginalImage=!1,this._canvas=null,this._irrRegistryState=_,this._resultReceiverSet=new Set,this._isaStateListenerSet=new Set,this._resultFilterSet=new Set,this._intermediateResultReceiverSet=new Set,this._intermediateResultManager=null,this._templateName="Default",this._bOpenDetectVerify=!1,this._bOpenNormalizeVerify=!1,this._bOpenBarcodeVerify=!1,this._bOpenLabelVerify=!1,this._minImageCaptureInterval=0,this._averageProcessintTimeArray=[],this._averageFetchImageTimeArray=[],this._currentSettings=null,this._averageTime=999,this.captureInParallel=!0,this.bDestroyed=!1,this._promiseStartScan=null}get maxCvsSideLength(){return this._maxCvsSideLength}set maxCvsSideLength(e){this._maxCvsSideLength=e}get isa(){return this._isa}set isa(e){this._isa=e}get disposed(){return this.bDestroyed}_checkIsDisposed(){if(this.disposed)throw new Error('"CaptureVisionRouter" instance has been disposed')}static async createInstance(){if(!i.license)throw Error("Module `license` is not existed.");await i.license.initLicense(),await o(["DIP","CVR"]);const e=new O,t=new g;let a=c();return l[a]=async i=>{var a;if(i.success)e._instanceID=i.instanceID,e._currentSettings=await e.outputSettings("*"),y._version=`2.0.20-dev-20231215173430(Worker: ${null===(a=s.cvr)||void 0===a?void 0:a.worker}, Wasm: ${i.version})`,0===n.bSupportDce4Module&&(e._intermediateResultManager=e.getIntermediateResultManager(!0)),t.resolve(e);else{const e=Error(i.message);i.stack&&(e.stack=i.stack),t.reject(e)}},d.postMessage({type:"cvr_createInstance",id:a}),t}setInput(e){if(this._checkIsDisposed(),e){if(this.isa=e,e.isCameraEnhancer){this.isa.setPixelFormat(a.IPF_GRAYSCALED),this._intermediateResultManager&&(this.isa._intermediateResultReceiver.isDce=!0,this._intermediateResultManager.addResultReceiver(this.isa._intermediateResultReceiver));const t=this.isa.getCameraView();if(t){const e=t._capturedResultReceiver;e.isDce=!0,this._resultReceiverSet.add(e)}e.on("singleFrameAcquired",(async e=>{for(let t of this._resultReceiverSet)this._bNeedOutputOriginalImage&&t.onOriginalImageResultReceived&&t.onOriginalImageResultReceived({imageData:e});const t={bytes:new Uint8Array(e.bytes),width:e.width,height:e.height,stride:e.stride,format:e.format,tag:e.tag},i=await this.capture(t,this._templateName);i.originalImageTag=e.tag;for(let e of this._resultReceiverSet)e.isDce&&e.onCapturedResultReceived(i,{isDetectVerifyOpen:!1,isNormalizeVerifyOpen:!1,isBarcodeVerifyOpen:!1,isLabelVerifyOpen:!1});const s=T(i);for(let e of this._resultReceiverSet)e.onDecodedBarcodesReceived&&s.barcodesResultItems.length&&e.onDecodedBarcodesReceived({originalImageHashId:i.originalImageHashId,originalImageTag:i.originalImageTag,barcodesResultItems:s.barcodesResultItems.filter((e=>!e.isFilter))}),e.onRecognizedTextLinesReceived&&s.textLinesResultItems.length&&e.onRecognizedTextLinesReceived({textLinesResultItems:s.textLinesResultItems}),e.onDetectedQuadsReceived&&s.quadsResultItems.length&&e.onDetectedQuadsReceived({originalImageHashId:i.originalImageHashId,originalImageTag:i.originalImageTag,quadsResultItems:s.quadsResultItems}),e.onNormalizedImagesReceived&&s.normalizedImageResultItems.length&&e.onNormalizedImagesReceived({originalImageHashId:i.originalImageHashId,originalImageTag:i.originalImageTag,normalizedImageResultItems:s.normalizedImageResultItems}),e.onParsedResultsReceived&&s.parsedResultItems.length&&e.onParsedResultsReceived({parsedResultItems:s.parsedResultItems}),e.onCapturedResultReceived&&!e.isDce&&(i.items=i.items.filter((e=>!e.isFilter)),e.onCapturedResultReceived(i))}))}}else this.isa=null}getInput(){return this._isa}addImageSourceStateListener(e){if(this._checkIsDisposed(),"object"!=typeof e)return console.warn("Invalid ISA state listener.");e&&Object.keys(e)&&this._isaStateListenerSet.add(e)}removeImageSourceStateListener(e){return this._checkIsDisposed(),this._isaStateListenerSet.delete(e)}addResultReceiver(e){if(this._checkIsDisposed(),"object"!=typeof e)throw new Error("Invalid receiver.");if(e&&Object.keys(e).length){this._resultReceiverSet.add(e);for(let t in e){let i=e[t];Object.defineProperty(e,t,{configurable:!0,get:()=>i,set:async e=>{i=e,this._setCrrRegistry()}})}this._setCrrRegistry()}}removeResultReceiver(e){this._checkIsDisposed(),this._resultReceiverSet.delete(e),this._setCrrRegistry()}async _setCrrRegistry(){const e={onCapturedResultReceived:!1,onDecodedBarcodesReceived:!1,onRecognizedTextLinesReceived:!1,onDetectedQuadsReceived:!1,onNormalizedImagesReceived:!1};for(let t of this._resultReceiverSet)t.isDce||(t.onCapturedResultReceived&&(e.onCapturedResultReceived=!0),t.onDecodedBarcodesReceived&&(e.onDecodedBarcodesReceived=!0),t.onRecognizedTextLinesReceived&&(e.onRecognizedTextLinesReceived=!0),t.onDetectedQuadsReceived&&(e.onDetectedQuadsReceived=!0),t.onNormalizedImagesReceived&&(e.onNormalizedImagesReceived=!0));const t=new g;let i=c();return l[i]=async e=>{if(e.success)t.resolve();else{let i=new Error(e.message);i.stack=e.stack+"\n"+i.stack,t.reject()}},d.postMessage({type:"cvr_setCrrRegistry",id:i,instanceID:this._instanceID,body:{receiver:JSON.stringify(e)}}),t}async addResultFilter(e){if(this._checkIsDisposed(),"object"!=typeof e)return console.warn("Invalid filter.");if(e&&Object.keys(e)){for(let t in e.verificationEnabled)await this._enableResultCrossVerification(Number(t),await e.verificationEnabled[t]);for(let t in e.duplicateFilterEnabled)await this._enableResultDeduplication(Number(t),await e.duplicateFilterEnabled[t]);for(let t in e.duplicateForgetTime)await this._setDuplicateForgetTime(Number(t),await e.duplicateForgetTime[t]);this._resultFilterSet.add(e),this._handleFilterSwitch();for(let t in e.verificationEnabled){let i=e.verificationEnabled[Number(t)];Object.defineProperty(e.verificationEnabled,t,{configurable:!0,get:()=>i,set:async e=>{i=e,this._handleFilterSwitch(),await this._enableResultCrossVerification(Number(t),e)}})}for(let t in e.duplicateFilterEnabled){let i=e.duplicateFilterEnabled[Number(t)];Object.defineProperty(e.duplicateFilterEnabled,t,{configurable:!0,get:()=>i,set:async e=>{i=e,await this._enableResultDeduplication(Number(t),e)}})}for(let t in e.duplicateForgetTime){let i=e.duplicateForgetTime[Number(t)];Object.defineProperty(e.duplicateForgetTime,t,{configurable:!0,get:()=>i,set:async e=>{e>18e4&&(e=18e4),e<0&&(e=0),i=e,await this._setDuplicateForgetTime(Number(t),e)}})}}}removeResultFilter(e){this._checkIsDisposed(),this._resultFilterSet.delete(e),this._handleFilterSwitch()}_handleFilterSwitch(){this._bOpenBarcodeVerify=!1,this._bOpenLabelVerify=!1,this._bOpenDetectVerify=!1,this._bOpenNormalizeVerify=!1;for(let e of this._resultFilterSet)e.isResultCrossVerificationEnabled(r.CRIT_BARCODE)&&(this._bOpenBarcodeVerify=!0),e.isResultCrossVerificationEnabled(r.CRIT_TEXT_LINE)&&(this._bOpenLabelVerify=!0),e.isResultCrossVerificationEnabled(r.CRIT_DETECTED_QUAD)&&(this._bOpenDetectVerify=!0),e.isResultCrossVerificationEnabled(r.CRIT_NORMALIZED_IMAGE)&&(this._bOpenNormalizeVerify=!0)}async startCapturing(e="Default"){if(this._checkIsDisposed(),!this._bPauseScan)return;if(!this.isa)throw new Error("'ImageSourceAdapter' is not set. call 'setInput' before 'startCapturing'");if(void 0!==this.isa.singleFrameMode&&"disabled"!==this.isa.singleFrameMode)return void(this._templateName=e);if(O._oldTemplateMap&&O._oldTemplateMap[e]&&(e=O._oldTemplateMap[e]),!this._currentSettings.CaptureVisionTemplates.find((t=>t.Name===e)))throw new Error("Non-existent template name, please confirm whether initSettings is successful.");O._builtInDbrTemplates.includes(e)&&!n.isModuleLoaded("dbr")?await o("dbr"):O._builtInDlrTemplates.includes(e)&&!n.isModuleLoaded("dlr")?await o("dlr"):O._builtInDdnTemplates.includes(e)&&!n.isModuleLoaded("ddn")&&await o("ddn");return this.isa.getColourChannelUsageType()===u.CCUT_AUTO&&(S(this._currentSettings).includes("ddn")?this.isa.setColourChannelUsageType(u.CCUT_FULL_CHANNEL):this.isa.setColourChannelUsageType(u.CCUT_Y_CHANNEL_ONLY)),this._promiseStartScan&&this._promiseStartScan.isPending?this._promiseStartScan:(this._promiseStartScan=new g(((t,i)=>{if(this.disposed)return;let s=c();l[s]=async s=>{if(this._promiseStartScan&&!this._promiseStartScan.isFulfilled){if(!s.success){let e=new Error(s.message);return e.stack=s.stack+"\n"+e.stack,i(e)}["ReadBarcodes_ReadRateFirst","ReadBarcodes_Balance","ReadDenseBarcodes"].includes(e.toLowerCase())&&(this.maxCvsSideLength=4096);for(let e of this._resultFilterSet)await this.addResultFilter(e);this._bNeedOutputOriginalImage=s.bNeedOutputOriginalImage,this._bPauseScan=!1,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((async()=>{-1!==this._minImageCaptureInterval&&this.isa.startFetching(),this._loopReadVideo(e),t()}),0)}},this.isa.isCameraEnhancer&&this.isa.getCameraView().setScanLaserVisible(!0),d.postMessage({type:"cvr_startCapturing",id:s,instanceID:this._instanceID,body:{templateName:e}})})),await this._promiseStartScan)}stopCapturing(){this._checkIsDisposed(),this.isa&&(this.isa.stopFetching(),this._clearVerifyList(),this._averageProcessintTimeArray=[],this._averageTime=999,this.isa.isCameraEnhancer&&this.isa.getCameraView().setScanLaserVisible(!1),this._bPauseScan=!0,this._promiseStartScan=null,this.isa.setColourChannelUsageType(u.CCUT_AUTO),this.maxCvsSideLength=["iPhone","Android","HarmonyOS"].includes(n.browserInfo.OS)?2048:4096)}async _clearVerifyList(){let e=c();const t=new g;return l[e]=async e=>{if(e.success)return t.resolve();{let i=new Error(e.message);return i.stack=e.stack+"\n"+i.stack,t.reject(i)}},d.postMessage({type:"cvr_clearVerifyList",id:e,instanceID:this._instanceID}),t}async _getIntermediateResult(){this._checkIsDisposed();let e=c();const t=new g;return l[e]=async e=>{if(e.success)t.resolve(e.result);else{let i=new Error(e.message);i.stack=e.stack+"\n"+i.stack,t.reject(i)}},d.postMessage({type:"cvr_getIntermediateResult",id:e,instanceID:this._instanceID}),t}async _loopReadVideo(e){if(this.disposed||this._bPauseScan)return;if(this.isa.isBufferEmpty())if(this.isa.hasNextImageToFetch())for(let e of this._isaStateListenerSet)e.onImageSourceStateListener&&e.onImageSourceStateListener(v.ISS_BUFFER_EMPTY);else if(!this.isa.hasNextImageToFetch())for(let e of this._isaStateListenerSet)e.onImageSourceStateListener&&e.onImageSourceStateListener(v.ISS_EXHAUSTED);if(-1===this._minImageCaptureInterval||this.isa.isBufferEmpty())try{O._onLog&&O._onLog(`DCE: start fetching a frame: ${Date.now()}`),this._dsImage=this.isa.fetchImage(),O._onLog&&O._onLog(`DCE: finish fetching a frame: ${Date.now()}`),this.isa.setImageFetchInterval(this._averageTime)}catch(t){return void this._reRunCurrnetFunc(e)}else if(this.isa.setImageFetchInterval(this._averageTime-(this._dsImage&&this._dsImage.tag?this._dsImage.tag.timeSpent:0)),this._dsImage=this.isa.getImage(),this._dsImage.tag&&Date.now()-this._dsImage.tag.timeStamp>200)return void this._reRunCurrnetFunc(e);if(!this._dsImage)return void this._reRunCurrnetFunc(e);for(let e of this._resultReceiverSet)this._bNeedOutputOriginalImage&&e.onOriginalImageResultReceived&&e.onOriginalImageResultReceived({imageData:this._dsImage});const t=Date.now();let i=null;this._captureDsimage(this._dsImage,e,!0).then((async s=>{if(i=s,this._bPauseScan)return void this._reRunCurrnetFunc(e);const a=i.intermediateResult;if(a){if(a.taskSet)for(let e of a.taskSet.intermediateResultUnits)e.originalImageTag=this._dsImage.tag?this._dsImage.tag:null;for(let e of this._intermediateResultReceiverSet){if(a.taskSet&&e.onTaskResultsReceived&&e.onTaskResultsReceived({intermediateResultUnits:a.taskSet.intermediateResultUnits},a.taskSet.info),a.sectionSet)for(let t in a.sectionSet){for(let i of a.sectionSet[t].asStage)e[t]&&e[t](i.result,i.info);for(let i of a.sectionSet[t].asSection)e[t]&&e[t](i.result,i.info)}if(a.stageSet)for(let t in a.stageSet)for(let i of a.stageSet[t])e[t]&&e[t](i.result,i.info)}}i.originalImageTag=this._dsImage.tag?this._dsImage.tag:null;for(let e of this._resultReceiverSet)e.isDce&&e.onCapturedResultReceived(i,{isDetectVerifyOpen:this._bOpenDetectVerify,isNormalizeVerifyOpen:this._bOpenNormalizeVerify,isBarcodeVerifyOpen:this._bOpenBarcodeVerify,isLabelVerifyOpen:this._bOpenLabelVerify});for(let e of this._resultFilterSet)e.onDecodedBarcodesReceived(i.items),e.onRecognizedTextLinesReceived(i.items),e.onDetectedQuadsReceived(i.items),e.onNormalizedImagesReceived(i.items);const r=T(i),n={originalImageHashId:i.originalImageHashId,originalImageTag:i.originalImageTag,errorCode:i.errorCode,errorString:i.errorString};for(let e of this._resultReceiverSet)e.onDecodedBarcodesReceived&&r.barcodesResultItems.length&&e.onDecodedBarcodesReceived(Object.assign(Object.assign({},n),{barcodesResultItems:r.barcodesResultItems.filter((e=>!e.isFilter))})),e.onRecognizedTextLinesReceived&&r.textLinesResultItems.length&&e.onRecognizedTextLinesReceived(Object.assign(Object.assign({},n),{textLinesResultItems:r.textLinesResultItems.filter((e=>!e.isFilter))})),e.onDetectedQuadsReceived&&r.quadsResultItems.length&&e.onDetectedQuadsReceived(Object.assign(Object.assign({},n),{quadsResultItems:r.quadsResultItems.filter((e=>!e.isFilter))})),e.onNormalizedImagesReceived&&r.normalizedImageResultItems.length&&e.onNormalizedImagesReceived(Object.assign(Object.assign({},n),{normalizedImageResultItems:r.normalizedImageResultItems.filter((e=>!e.isFilter))})),e.onParsedResultsReceived&&r.parsedResultItems.length&&e.onParsedResultsReceived(Object.assign(Object.assign({},n),{parsedResultItems:r.parsedResultItems})),e.onCapturedResultReceived&&!e.isDce&&(i.items=i.items.filter((e=>!e.isFilter)),e.onCapturedResultReceived(i));const o=Date.now()-t;this._minImageCaptureInterval>-1&&(5===this._averageProcessintTimeArray.length&&this._averageProcessintTimeArray.shift(),5===this._averageFetchImageTimeArray.length&&this._averageFetchImageTimeArray.shift(),this._averageProcessintTimeArray.push(o),this._averageFetchImageTimeArray.push(this._dsImage&&this._dsImage.tag?this._dsImage.tag.timeSpent:0),this._averageTime=Math.min(...this._averageProcessintTimeArray)-Math.max(...this._averageFetchImageTimeArray),this._averageTime=this._averageTime>0?this._averageTime:0,O._onLog&&(O._onLog(`minImageCaptureInterval: ${this._minImageCaptureInterval}`),O._onLog(`averageProcessintTimeArray: ${this._averageProcessintTimeArray}`),O._onLog(`averageFetchImageTimeArray: ${this._averageFetchImageTimeArray}`),O._onLog(`averageTime: ${this._averageTime}`))),O._onLog&&O._onLog(`time finish decode: ${Date.now()}`),O._onLog&&O._onLog("===================================================="),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._minImageCaptureInterval>0&&this._minImageCaptureInterval>=this._averageTime?this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo(e)}),this._minImageCaptureInterval-this._averageTime):this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo(e)}),Math.max(this._minImageCaptureInterval,0))})).catch((t=>{this.isa.stopFetching(),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this.isa.startFetching(),this._loopReadVideo(e)}),Math.max(this._minImageCaptureInterval,1e3)),"platform error"!==t.message&&console.warn(t.message)})).finally((()=>{i&&i.intermediateResult&&delete i.intermediateResult}))}_reRunCurrnetFunc(e){this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo(e)}),0)}async capture(e,t="Default",i=!1){if(this._checkIsDisposed(),!e)return null;if(O._oldTemplateMap&&O._oldTemplateMap[t]&&(t=O._oldTemplateMap[t]),["ReadBarcodes_ReadRateFirst","ReadBarcodes_Balance","ReadDenseBarcodes"].includes(t.toLowerCase())&&(this.maxCvsSideLength=4096),!this._currentSettings.CaptureVisionTemplates.find((e=>e.Name===t)))throw new Error("Non-existent template name, please confirm whether initSettings is successful.");let s;if(O._builtInDbrTemplates.includes(t)&&!n.isModuleLoaded("dbr")?await o("dbr"):O._builtInDlrTemplates.includes(t)&&!n.isModuleLoaded("dlr")?await o("dlr"):O._builtInDdnTemplates.includes(t)&&!n.isModuleLoaded("ddn")&&await o("ddn"),(a=e)&&"object"==typeof a&&!Array.isArray(a)&&"bytes"in a&&"width"in a&&"height"in a&&"stride"in a&&"format"in a)s=await this._captureDsimage(e,t,i);else if("string"==typeof e)s="data:image/"==e.substring(0,11)?await this._captureBase64(e,t,i):await this._captureUrl(e,t,i);else if(e instanceof Blob)s=await this._captureBlob(e,t,i);else if(e instanceof HTMLImageElement)s=await this._captureImage(e,t,i);else if(e instanceof HTMLCanvasElement)s=await this._captureCanvas(e,t,i);else if(e instanceof HTMLVideoElement)s=await this._captureVideo(e,t,i);else{if(!(e instanceof Uint8Array||e instanceof ArrayBuffer||e instanceof Uint8ClampedArray))throw new TypeError("'capture(imageOrFile, templateName)': Type of 'imageOrFile' should be 'DSImageData', 'Url', 'Base64', 'Blob', 'Uint8Array', 'ArrayBuffer', 'Uint8ClampedArray', 'HTMLImageElement', 'HTMLCanvasElement', 'HTMLVideoElement'.");s=await this._captureBlob(new Blob([new Uint8Array(e)],{type:"image/png"}),t,i)}var a;const r=await this._getIntermediateResult();if(r)for(let e of this._intermediateResultReceiverSet){if(r.taskSet&&e.onTaskResultsReceived&&e.onTaskResultsReceived({intermediateResultUnits:r.taskSet.intermediateResultUnits},r.taskSet.info),r.sectionSet)for(let t in r.sectionSet){for(let i of r.sectionSet[t].asStage)e[t]&&e[t](i.result,i.info);for(let i of r.sectionSet[t].asSection)e[t]&&e[t](i.result,i.info)}if(r.stageSet)for(let t in r.stageSet)for(let i of r.stageSet[t])e[t]&&e[t](i.result,i.info)}return s}async _captureDsimage(e,t,i=!1){return await this._captureInWorker(e,t,i)}async _captureUrl(e,t,i=!1){let s=await w(e,"blob");return await this._captureBlob(s,t,i)}async _captureBase64(e,t,i=!1){e=e.substring(e.indexOf(",")+1);let s=atob(e),a=s.length,r=new Uint8Array(a);for(;a--;)r[a]=s.charCodeAt(a);return await this._captureBlob(new Blob([r]),t,i)}async _captureBlob(e,t,i=!1){let s=null,a=null;if("undefined"!=typeof createImageBitmap)try{s=await createImageBitmap(e)}catch(e){}s||(a=await async function(e){return await new Promise(((t,i)=>{let s=URL.createObjectURL(e),a=new Image;a.src=s,a.onload=()=>{URL.revokeObjectURL(a.dbrObjUrl),t(a)},a.onerror=e=>{i(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}}))}(e));let r=await this._captureImage(s||a,t,i);return s&&s.close(),r}async _captureImage(e,t,i=!1){let s,a,r=e instanceof HTMLImageElement?e.naturalWidth:e.width,n=e instanceof HTMLImageElement?e.naturalHeight:e.height,o=Math.max(r,n);if(o>this.maxCvsSideLength){let e=this.maxCvsSideLength/o;s=Math.round(r*e),a=Math.round(n*e)}else s=r,a=n;this._canvas||(this._canvas=document.createElement("canvas"));const c=this._canvas;c.width===s&&c.height===a||(c.width=s,c.height=a),c.ctx2d||(c.ctx2d=c.getContext("2d",{willReadFrequently:!0}));return c.ctx2d.drawImage(e,0,0,r,n,0,0,s,a),e.dbrObjUrl&&URL.revokeObjectURL(e.dbrObjUrl),await this._captureCanvas(c,t,i)}async _captureCanvas(e,t,i=!1){if(e.crossOrigin&&"anonymous"!=e.crossOrigin)throw"cors";if([e.width,e.height].includes(0))throw Error("The width or height of the 'canvas' is 0.");const s=e.ctx2d||e.getContext("2d",{willReadFrequently:!0}),a={bytes:Uint8Array.from(s.getImageData(0,0,e.width,e.height).data),width:e.width,height:e.height,stride:4*e.width,format:10};return await this._captureInWorker(a,t,i)}async _captureVideo(e,t,i=!1){if(e.crossOrigin&&"anonymous"!=e.crossOrigin)throw"cors";let s,a,r=e.videoWidth,n=e.videoHeight,o=Math.max(r,n);if(o>this._maxCvsSideLength){let e=this._maxCvsSideLength/o;s=Math.round(r*e),a=Math.round(n*e)}else s=r,a=n;this._canvas||(this._canvas=document.createElement("canvas"));const c=this._canvas;c.width===s&&c.height===a||(c.width=s,c.height=a),c.ctx2d||(c.ctx2d=c.getContext("2d",{willReadFrequently:!0}));return c.ctx2d.drawImage(e,0,0,r,n,0,0,s,a),await this._captureCanvas(c,t,i)}async _captureInWorker(e,t,i=!1){const{bytes:s,width:a,height:o,stride:u,format:h}=e;i||(this.maxCvsSideLength=["iPhone","Android","HarmonyOS"].includes(n.browserInfo.OS)?2048:4096);let p=c();const _=new g;return l[p]=async e=>{if(!e.success){let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,_.reject(t)}O._onLog&&O._onLog(`get result time from worker: ${Date.now()}`);try{const t=e.captureResult;this._dsImage&&(this._dsImage.bytes=e.bytes);for(let e=0;e<t.items.length;e++)if(t.items[e].type===r.CRIT_NORMALIZED_IMAGE){const i=D(t.items[e].imageData);C(t.items[e],i)}else t.items[e].type===r.CRIT_ORIGINAL_IMAGE?t.items[e].imageData=this._dsImage:t.items[e].type===r.CRIT_PARSED_RESULT&&m(t.items[e]);return _.resolve(t)}catch(e){return _.reject(e)}},O._onLog&&O._onLog(`send buffer to worker: ${Date.now()}`),d.postMessage({type:"cvr_capture",id:p,instanceID:this._instanceID,body:{bytes:s,width:a,height:o,stride:u,format:h,templateName:t||"",bScanner:i}},[s.buffer]),_}async initSettings(e){return this._checkIsDisposed(),e&&["string","object"].includes(typeof e)?("string"==typeof e&&(/^(https:\/\/www\.|http:\/\/www\.|https:\/\/|http:\/\/)|^[a-zA-Z0-9]{2,}(\.[a-zA-Z0-9]{2,})(\.[a-zA-Z0-9]{2,})?/.test(e)&&(e=await w(e,"text")),this._currentSettings=JSON.parse(e)),"object"==typeof e&&(this._currentSettings=e,e=JSON.stringify(e)),await o(S(this._currentSettings)),await new Promise(((t,i)=>{let s=c();l[s]=async e=>{if(e.success){const s=JSON.parse(e.response);if(0!==s.exception){let e=new Error(s.description?s.description:"Init Settings Failed.");return e.errorCode=s.exception,i(e)}return O._oldTemplateMap=null,this._bNeedOutputOriginalImage=1===this._currentSettings.CaptureVisionTemplates[0].OutputOriginalImage,t(s)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,i(t)}},d.postMessage({type:"cvr_initSettings",id:s,instanceID:this._instanceID,body:{settings:e}})}))):console.error("Invalid template.")}async outputSettings(e){if(this._checkIsDisposed(),O._oldTemplateMap&&O._oldTemplateMap[e]&&(e=O._oldTemplateMap[e]),e&&"*"!==e&&this._currentSettings&&!this._currentSettings.CaptureVisionTemplates.find((t=>t.Name===e)))throw new Error("Non-existent template name.");return await new Promise(((t,i)=>{let s=c();l[s]=async e=>{if(e.success){const s=JSON.parse(e.settings);if(0!==s.errorCode){let e=new Error(s.errorString);return e.errorCode=s.errorCode,i(e)}return delete s.errorCode,delete s.errorString,t(s)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,i(t)}},d.postMessage({type:"cvr_outputSettings",id:s,instanceID:this._instanceID,body:{templateName:e||"Default"}})}))}async outputSettingsToFile(e,t,i){const s=await this.outputSettings(e),a=new Blob([JSON.stringify(s,null,2,(function(e,t){return t instanceof Array?JSON.stringify(t):t}),2)],{type:"application/json"});if(i){const e=document.createElement("a");e.href=URL.createObjectURL(a),t.endsWith(".json")&&(t=t.replace(".json","")),e.download=`${t}.json`,e.onclick=()=>{setTimeout((()=>{URL.revokeObjectURL(e.href)}),500)},e.click()}return a}async getSimplifiedSettings(e="Default"){if(this._checkIsDisposed(),O._oldTemplateMap&&O._oldTemplateMap[e]&&(e=O._oldTemplateMap[e]),!this._currentSettings.CaptureVisionTemplates.find((t=>t.Name===e)))throw new Error("Non-existent template name.");return await new Promise(((t,i)=>{let s=c();l[s]=async e=>{if(e.success){const s=JSON.parse(e.settings,((e,t)=>E&&"barcodeFormatIds"===e?BigInt(t):t));if(s.minImageCaptureInterval=this._minImageCaptureInterval,0!==s.code){let e=new Error(s.codeString);return e.errorCode=s.errorCode,i(e)}return delete s.code,delete s.codeString,t(s)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,i(t)}},d.postMessage({type:"cvr_getSimplifiedSettings",id:s,instanceID:this._instanceID,body:{templateName:e}})}))}async updateSettings(e,t){if(this._checkIsDisposed(),O._oldTemplateMap&&O._oldTemplateMap[e]&&(e=O._oldTemplateMap[e]),!this._currentSettings.CaptureVisionTemplates.find((t=>t.Name===e)))throw new Error("Non-existent template name.");return await new Promise(((i,s)=>{let a=c();l[a]=async e=>{if(e.success){const a=JSON.parse(e.response);if(t.minImageCaptureInterval&&t.minImageCaptureInterval>=-1&&(this._minImageCaptureInterval=t.minImageCaptureInterval),this._bNeedOutputOriginalImage=e.bNeedOutputOriginalImage,0!==a.exception){let e=new Error(a.description?a.description:"Update Settings Failed.");return e.errorCode=a.exception,s(e)}return this._currentSettings=await this.outputSettings("*"),i(a)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,s(t)}},d.postMessage({type:"cvr_updateSettings",id:a,instanceID:this._instanceID,body:{settings:t,templateName:e}})}))}async resetSettings(){return this._checkIsDisposed(),await new Promise(((e,t)=>{let i=c();l[i]=async i=>{if(i.success){const s=JSON.parse(i.response);if(0!==s.exception){let e=new Error(s.description?s.description:"Reset Settings Failed.");return e.errorCode=s.exception,t(e)}return this._currentSettings=await this.outputSettings("*"),e(s)}{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}},d.postMessage({type:"cvr_resetSettings",id:i,instanceID:this._instanceID})}))}getIntermediateResultManager(e){if(this._checkIsDisposed(),!e&&0!==n.bSupportIRTModule)throw new Error("The current license does not support the use of intermediate results.");return this._intermediateResultManager||(this._intermediateResultManager=new p,this._intermediateResultManager.addResultReceiver=async e=>{if("object"!=typeof e)throw new Error("Invalid receiver.");this._intermediateResultReceiverSet.add(e),this._handleIntermediateResultReceiver();for(let i in e){let s=e[i];Object.defineProperty(e,i,{configurable:!0,get:()=>s,set:async e=>{s=e,this._handleIntermediateResultReceiver(),await t()}})}const t=async()=>await new Promise(((e,t)=>{let i=c();l[i]=async i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}},d.postMessage({type:"cvr_setIrrRegistry",id:i,instanceID:this._instanceID,body:{receiverObj:this._irrRegistryState}})}));return await t()},this._intermediateResultManager.removeResultReceiver=async e=>(this._intermediateResultReceiverSet.delete(e),this._handleIntermediateResultReceiver(),await new Promise(((e,t)=>{let i=c();l[i]=async i=>{if(i.success)return e();{let e=new Error(i.message);return e.stack=i.stack+"\n"+e.stack,t(e)}},d.postMessage({type:"cvr_setIrrRegistry",id:i,instanceID:this._instanceID,body:{receiverObj:this._irrRegistryState}})}))),this._intermediateResultManager.getOriginalImage=async e=>this._dsImage),this._intermediateResultManager}_handleIntermediateResultReceiver(){for(let e in this._irrRegistryState)this._irrRegistryState[e]=!1;for(let e of this._intermediateResultReceiverSet)if(e.isDce)this._irrRegistryState.onTaskResultsReceivedForDce=!0;else for(let t in e)this._irrRegistryState[t]||(this._irrRegistryState[t]=!!e[t])}async _enableResultCrossVerification(e,t){return this._checkIsDisposed(),await new Promise(((i,s)=>{let a=c();l[a]=async e=>{if(e.success)return i(e.result);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,s(t)}},d.postMessage({type:"cvr_enableResultCrossVerification",id:a,instanceID:this._instanceID,body:{type:e,enabled:t}})}))}async _enableResultDeduplication(e,t){return this._checkIsDisposed(),await new Promise(((i,s)=>{let a=c();l[a]=async e=>{if(e.success)return i(e.result);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,s(t)}},d.postMessage({type:"cvr_enableResultDeduplication",id:a,instanceID:this._instanceID,body:{type:e,enabled:t}})}))}async _setDuplicateForgetTime(e,t){return this._checkIsDisposed(),await new Promise(((i,s)=>{let a=c();l[a]=async e=>{if(e.success)return i(e.result);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,s(t)}},d.postMessage({type:"cvr_setDuplicateForgetTime",id:a,instanceID:this._instanceID,body:{type:e,time:t}})}))}async _getDuplicateForgetTime(e){return this._checkIsDisposed(),await new Promise(((t,i)=>{let s=c();l[s]=async e=>{if(e.success)return t(e.time);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,i(t)}},d.postMessage({type:"cvr_getDuplicateForgetTime",id:s,instanceID:this._instanceID,body:{type:e}})}))}async _setThresholdValue(e,t,i){return await new Promise(((s,a)=>{let r=c();l[r]=async e=>{if(e.success)return s();{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,a(t)}},d.postMessage({type:"cvr_setThresholdValue",id:r,instanceID:this._instanceID,body:{threshold:e,leftLimit:t,rightLimit:i}})}))}contains(e,t){return function(e,t){let i=t.x,s=t.y,a=e[0].x,r=e[0].y,n=e[1].x,o=e[1].y,c=e[2].x,l=e[2].y,d=e[3].x,u=e[3].y,m=_(i,s,a,r,n,o),h=_(i,s,n,o,c,l),g=_(i,s,c,l,d,u),p=_(i,s,d,u,a,r);function _(e,t,i,s,a,r){return(e-i)*(r-s)-(t-s)*(a-i)}return m>=0&&h>=0&&g>=0&&p>=0||m<=0&&h<=0&&g<=0&&p<=0}(e,t)}async dispose(){this._checkIsDisposed(),this._promiseStartScan&&this.stopCapturing(),this.isa=null,this._resultReceiverSet.clear(),this._isaStateListenerSet.clear(),this._resultFilterSet.clear(),this.bDestroyed=!0;let e=c();l[e]=e=>{if(!e.success){let t=new Error(e.message);throw t.stack=e.stack+"\n"+t.stack,t}},d.postMessage({type:"cvr_dispose",id:e,instanceID:this._instanceID})}}O._oldTemplateMap={default:"Default","read-barcodes":"ReadBarcodes_Default","recognize-textlines":"RecognizeTextLines_Default","detect-document-boundaries":"DetectDocumentBoundaries_Default","detect-and-normalize-document":"DetectAndNormalizeDocument_Default","normalize-document":"NormalizeDocument_Default"},O._builtInDbrTemplates=["ReadBarcodes_Balance","ReadBarcodes_Default","ReadBarcodes_ReadRateFirst","ReadBarcodes_SpeedFirst","ReadDenseBarcodes","ReadDistantBarcodes","ReadSingleBarcode"],O._builtInDlrTemplates=["RecognizeTextLines_Default","RecognizeNumbers","RecognizeLetters","RecognizeUppercaseLetters","RecognizeNumbersAndUppercaseLetters","RecognizeNumbersAndLetters"],O._builtInDdnTemplates=["DetectAndNormalizeDocument_Default","DetectDocumentBoundaries_Default","NormalizeDocument_Default"];class U{constructor(){this.onCapturedResultReceived=null,this.onOriginalImageResultReceived=null,this.onDecodedBarcodesReceived=null,this.onRecognizedTextLinesReceived=null,this.onDetectedQuadsReceived=null,this.onNormalizedImagesReceived=null,this.onParsedResultsReceived=null}}class N{constructor(){this.onTaskResultsReceived=null,this.onPredetectedRegionsReceived=null,this.onLocalizedBarcodesReceived=null,this.onDecodedBarcodesReceived=null,this.onLocalizedTextLinesReceived=null,this.onRecognizedTextLinesReceived=null,this.onDetectedQuadsReceived=null,this.onNormalizedImagesReceived=null,this.onColourImageUnitReceived=null,this.onScaledDownColourImageUnitReceived=null,this.onGrayscaleImageUnitReceived=null,this.onTransformedGrayscaleImageUnitReceived=null,this.onEnhancedGrayscaleImageUnitReceived=null,this.onBinaryImageUnitReceived=null,this.onTextureDetectionResultUnitReceived=null,this.onTextureRemovedGrayscaleImageUnitReceived=null,this.onTextureRemovedBinaryImageUnitReceived=null,this.onContoursUnitReceived=null,this.onLineSegmentsUnitReceived=null,this.onTextZonesUnitReceived=null,this.onTextRemovedBinaryImageUnitReceived=null,this.onLongLinesUnitReceived=null,this.onCornersUnitReceived=null,this.onCandidateQuadEdgesUnitReceived=null,this.onCandidateBarcodeZonesUnitReceived=null,this.onScaledUpBarcodeImageUnitReceived=null,this.onDeformationResistedBarcodeImageUnitReceived=null,this.onComplementedBarcodeImageUnitReceived=null}}export{O as CaptureVisionRouter,y as CaptureVisionRouterModule,U as CapturedResultReceiver,v as EnumImageSourceState,p as IntermediateResultManager,N as IntermediateResultReceiver};
//# sourceMappingURL=cvr.esm.js.map
